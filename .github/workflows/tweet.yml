name: Twitter Auto Post

on:
  schedule:
    - cron: "55 21 * * *"  # JST 06:55ï¼ˆGitHub ã®é…å»¶å¯¾ç­–ï¼‰
  workflow_dispatch:

jobs:
  tweet:
    runs-on: ubuntu-latest

    steps:
      - name: å®Ÿè¡Œæ™‚é–“ã‚’è¨˜éŒ²ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã€JST ã§è¡¨ç¤ºï¼‰
        run: |
          export TZ=Asia/Tokyo
          echo "ğŸ“… GitHub Actions ã®å®Ÿè¡Œæ™‚é–“ï¼ˆJSTï¼‰: $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
        uses: actions/checkout@v3

      - name: Python ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          echo "ğŸ“Œ Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
          python --version
          echo "ğŸ“Œ pip ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰"
          pip install --upgrade pip
          echo "ğŸ“Œ å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          pip install tweepy google-generativeai requests

      - name: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰
        run: |
          echo "ğŸ“Œ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
          pwd
          echo "ğŸ“Œ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          ls -la

      - name: "app.py ã®å­˜åœ¨ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ï¼‰"
        run: |
          if [ -f app.py ]; then
            echo "âœ… app.py found"
          else
            echo "âŒ app.py NOT found. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ã¾ã™ã€‚"
            exit 1
          fi

      - name: ç’°å¢ƒå¤‰æ•°ã®ãƒã‚§ãƒƒã‚¯
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_SECRET: ${{ secrets.API_SECRET }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.ACCESS_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$API_KEY" ] || [ -z "$API_SECRET" ] || [ -z "$ACCESS_TOKEN" ] || [ -z "$ACCESS_SECRET" ] || [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ ç’°å¢ƒå¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚Secrets ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          else
            echo "âœ… ç’°å¢ƒå¤‰æ•°ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚"
          fi

      - name: JST ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼‰
        run: |
          export TZ=Asia/Tokyo
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“… ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTï¼‰: $TODAY"
          echo "TODAY=$TODAY" >> $GITHUB_ENV  # ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ

      - name: Twitter ã«ãƒ„ã‚¤ãƒ¼ãƒˆï¼ˆJST ã®å½“æ—¥ã®æ—¥ä»˜ã‚’æ¸¡ã™ï¼‰
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_SECRET: ${{ secrets.API_SECRET }}
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.ACCESS_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python app.py "$TODAY"
